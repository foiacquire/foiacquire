#!/bin/bash
# Stealth browser management for foiacquire
# Uses a Docker container with Chromium for anti-bot bypass

set -e

CONTAINER_NAME="foiacquire-chromium"
IMAGE_NAME="foiacquire-chromium:latest"
PORT="${STEALTH_PORT:-9222}"

# Find project root (where Dockerfile.chromium lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

usage() {
    echo "Usage: stealth <command>"
    echo ""
    echo "Commands:"
    echo "  build    Build the stealth browser Docker image"
    echo "  start    Start the stealth browser container"
    echo "  stop     Stop the stealth browser container"
    echo "  restart  Restart the stealth browser container"
    echo "  status   Show container status"
    echo "  logs     Show container logs"
    echo ""
    echo "Environment:"
    echo "  STEALTH_PORT  Port to expose (default: 9222)"
}

cmd_build() {
    echo "Building stealth browser image..."

    # Create stealth entrypoint
    cat > "$PROJECT_DIR/bin/entrypoint-stealth.sh" << 'EOF'
#!/bin/sh
chromium-browser \
    --headless \
    --no-sandbox \
    --disable-gpu \
    --disable-dev-shm-usage \
    --disable-software-rasterizer \
    --disable-blink-features=AutomationControlled \
    --disable-infobars \
    --disable-background-networking \
    --disable-sync \
    --disable-translate \
    --no-first-run \
    --no-default-browser-check \
    --remote-debugging-port=9223 \
    "$@" &
sleep 2
exec socat TCP-LISTEN:9222,fork,reuseaddr,bind=0.0.0.0 TCP:127.0.0.1:9223
EOF
    chmod +x "$PROJECT_DIR/bin/entrypoint-stealth.sh"

    # Create stealth Dockerfile
    cat > "$PROJECT_DIR/Dockerfile.chromium-stealth" << 'EOF'
FROM alpine:latest
RUN apk add --no-cache chromium font-noto socat
RUN adduser -D chrome
USER chrome
EXPOSE 9222
COPY --chown=chrome:chrome bin/entrypoint-stealth.sh /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
CMD []
EOF

    docker build -t "$IMAGE_NAME" -f "$PROJECT_DIR/Dockerfile.chromium-stealth" "$PROJECT_DIR"
    echo "Done."
}

cmd_start() {
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "Stealth browser already running on port $PORT"
        return 0
    fi

    # Remove stopped container if exists
    docker rm "$CONTAINER_NAME" 2>/dev/null || true

    echo "Starting stealth browser on port $PORT..."
    docker run -d --rm \
        --name "$CONTAINER_NAME" \
        --shm-size=2g \
        --network host \
        "$IMAGE_NAME"

    echo "Stealth browser running. Connect with: ws://localhost:$PORT"
}

cmd_stop() {
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "Stopping stealth browser..."
        docker stop "$CONTAINER_NAME"
        echo "Stopped."
    else
        echo "Stealth browser not running."
    fi
}

cmd_restart() {
    cmd_stop && sleep 2
    cmd_start
}

cmd_status() {
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "Stealth browser: running on port $PORT"
        docker ps --filter "name=$CONTAINER_NAME" --format "  Container: {{.ID}}\n  Image: {{.Image}}\n  Status: {{.Status}}"
    else
        echo "Stealth browser: stopped"
    fi
}

cmd_logs() {
    docker logs "$CONTAINER_NAME" "$@"
}

case "${1:-}" in
    build)
        cmd_build
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
