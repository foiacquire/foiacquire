# Local production test environment
# Connects to production database and documents directory
#
# Usage:
#   docker-compose -f docker-compose.local.yml up doj-scraper
#   docker-compose -f docker-compose.local.yml up muckrock-scraper
#   docker-compose -f docker-compose.local.yml up server
#
# Required environment variables:
#   DATABASE_URL - PostgreSQL connection string
#
# Or create a .env.local file with:
#   DATABASE_URL=postgres://user:pass@host:port/db

services:
  doj-scraper:
    image: ghcr.io/monokrome/foiacquire:latest
    container_name: foiacquire-doj-local
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - RUST_LOG=${RUST_LOG:-info}
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
      - NO_TUI=1
    volumes:
      - /mnt/documents/research/foia:/opt/foiacquire
    command: ["scrape", "doj", "--daemon", "--interval", "90"]
    restart: unless-stopped

  muckrock-scraper:
    image: ghcr.io/monokrome/foiacquire:latest
    container_name: foiacquire-muckrock-local
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - RUST_LOG=${RUST_LOG:-info}
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
      - NO_TUI=1
    volumes:
      - /mnt/documents/research/foia:/opt/foiacquire
    command: ["scrape", "muckrock", "--daemon", "--interval", "90"]
    restart: unless-stopped

  server:
    image: ghcr.io/monokrome/foiacquire:latest
    container_name: foiacquire-server-local
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - RUST_LOG=${RUST_LOG:-info}
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
    volumes:
      - /mnt/documents/research/foia:/opt/foiacquire
    ports:
      - "3031:3030"
    command: ["serve", "0.0.0.0:3030"]
    restart: unless-stopped

  # One-off scrape (not daemon mode) for testing
  doj-scrape-once:
    image: ghcr.io/monokrome/foiacquire:latest
    container_name: foiacquire-doj-once
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - RUST_LOG=${RUST_LOG:-debug}
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
      - NO_TUI=1
    volumes:
      - /mnt/documents/research/foia:/opt/foiacquire
    command: ["scrape", "doj", "--limit", "5"]
    profiles:
      - debug

  # Status check
  status:
    image: ghcr.io/monokrome/foiacquire:latest
    container_name: foiacquire-status
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
    volumes:
      - /mnt/documents/research/foia:/opt/foiacquire
    command: ["status"]
    profiles:
      - debug
